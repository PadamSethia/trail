{% extends 'base.html' %}
{% block content %}



<div class="container" style="margin-top: 5rem;">

    {% if trans_semi %}

    <div class="modal is-active animated fadeIn" id="view_trans_modal">
        <div class="modal-background"></div>
        <div class="modal-content">

            <div class="box">
                <p>You have a saved draft - <span class="robo">Product Order
                        - {{trans_semi.id}}</span> ?</p>
                <br>
                <div class="field is-grouped">
                    <p class="control">
                        <a id="view_trans_draft" class="button is-black"><span class="icon icon-btn-in"><i
                                    data-feather="eye"></i></span>View
                        </a>
                    </p>
                    <p class="control">
                        <a id="delete_trans_draft" class="button is-danger"><span class="icon icon-btn-in"><i
                                    data-feather="x"></i></span>Delete
                        </a>
                    </p>
                    <p class="control">
                        <a class="button" id="cancel_trans_draft"><span class="icon icon-btn-in"><i
                                    data-feather="x"></i></span>Cancel
                        </a>
                    </p>

                    <script>
                        {% if  trans_semi %}
                        $('#view_trans_draft').click(function () {
                            document.location.href = "/trans_a_view/" + "{{ trans_semi.id }}" + "?edit=True&semi=True";


                        });
                        {% endif %}

                        $('#delete_trans_draft').on('click', function () {
                            var req = $.ajax({
                                method: "POST",
                                url: "{{ url_for('delete_trans' , trans_id = trans_semi.id) }}",
                            });

                        })
                    </script>

                </div>
            </div>
            <button class="modal-close is-large" aria-label="close"></button>

        </div>
        <script>
            $("#cancel_trans_draft").click(function (event) {
                event.preventDefault();
                var modal = document.querySelector('#view_trans_modal');  // assuming you have only 1
                var html = document.querySelector('html');

                modal.classList.remove('is-active');
                html.classList.remove('is-clipped');

                document.querySelector('.modal-close').addEventListener('click', function (e) {
                    e.preventDefault();
                    modal.classList.remove('is-active');
                    html.classList.remove('is-clipped');
                });

                modal.querySelector('.modal-background').addEventListener('click', function (e) {
                    e.preventDefault();
                    modal.classList.remove('is-active');
                    html.classList.remove('is-clipped');


                });

            })
            document.querySelector('#delete_trans_draft').addEventListener('click', function (event) {
                event.preventDefault();
                var modal = document.querySelector('#view_trans_modal');  // assuming you have only 1
                var html = document.querySelector('html');

                modal.classList.remove('is-active');
                html.classList.remove('is-clipped');

                document.querySelector('.modal-close').addEventListener('click', function (e) {
                    e.preventDefault();
                    modal.classList.remove('is-active');
                    html.classList.remove('is-clipped');
                });

                modal.querySelector('.modal-background').addEventListener('click', function (e) {
                    e.preventDefault();
                    modal.classList.remove('is-active');
                    html.classList.remove('is-clipped');


                });

            });

        </script>

    </div>

    {% endif %}
    <div class="columns is-mobile is-centered">
        <div class="column is-three-quarters">
            <nav class="level ">
                <div class="level-left ">

                    <div class="level-item">
                        <p class="is-size-5 ">
                            <span class="robo ">New Transaction - </span> Part A</p>
                    </div>
                </div>
                <div class="level-right">
                    <div class="buttons is-grouped-multiline is-centered">
                        <a href="{{ url_for('trans_a_view')}}" class=" button is-black"><span
                                class="icon icon-btn-in"><i data-feather="eye"></i></span>View</a>
                        <a id="save_trans_a" class=" button is-black"><span class="icon icon-btn-in"><i
                                    data-feather="save"></i></span>Save Draft</a>
                        <a class="button is-outlined is-black" id="copy_from_last_row"><span class="icon icon-btn-in"><i
                                    data-feather="copy"></i></span>Copy from last </a>
                    </div>
                </div>

            </nav>
            <hr>
            <div class="">
                <div class="form">
                    <form id="trans_a_form">
                        <div class="field-body is-horizontal">
                            <div class="field">
                                <label class="label">Product Order No.</label>
                                <div class="control has-icons-left">
                                    <input class="input robo" name="PP_no" value="{{pp_num}}" readonly>
                                    <span class="icon icon-btn-in is-left">
                                        <i data-feather="hash"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Start Date</label>
                                <div class="control has-icons-left">
                                    <input class="input" name="start-dates">
                                    <span class="icon is-small is-left">
                                        <i data-feather="calendar"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Target Date</label>
                                <div class="control has-icons-left">
                                    <input class="input" name="target-dates">
                                    <span class="icon is-small is-left">
                                        <i data-feather="calendar"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="field-body is-horizontal">
                            <div class="field">
                                <label class="label">Product</label>
                                <div class="control is-fullwidth select">
                                    <select id="prod_sel" name="prod_sel"></select>
                                </div>
                            </div>
                            <script>
                                $(document).ready(function () {
                                    var options = [];
                                    $.getJSON("{{url_for('get_fin_prod')}}", function (result) {
                                        var leng = Object.keys(result).length
                                        for (var i = 0; i < leng; i++) {
                                            options.push('<option value="',
                                                Object.keys(result)[i], '">',
                                                Object.values(result)[i], '</option>');
                                        }
                                        $("#prod_sel").html(options.join(''));
                                        $("#prod_sel").prop("selectedIndex", -1);

                                        var pp_sel = $("#prod_sel").val()


                                    });
                                })
                            </script>
                            <div class="field">
                                <label class="label">Prog. Qty</label>
                                <div class="control">
                                    <input class="input" name="prog_qty">

                                </div>
                            </div>

                            <div class="field">
                                <label class="label">U.O.M</label>
                                <div class="control">
                                    <input class="input robo" id="prod_uom" name="prod_uom" readonly>

                                    <script>

                                        $("#prod_sel").on('click', function () {

                                            var pp_sel = $("#prod_sel").val()
                                            $.getJSON("/get/uom/" + pp_sel, function (result) {
                                                console.log(result)
                                                $("#prod_uom").val(result);
                                            });
                                        })
                                    </script>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Original Sample</label>
                                <div class="control">
                                    <label class="radio">
                                        <input type="radio" name="samp_iss" value="yes">
                                        Yes
                                    </label>
                                    <label class="radio">
                                        <input type="radio" name="samp_iss" value="no">
                                        No
                                    </label>

                                </div>
                            </div>

                        </div>
                        <hr>
                        <div class="field is-horizontal">
                            <div class="field-label is-normal">
                                <label class="label">Programme By</label>
                            </div>
                            <div class="field-body">
                                <div class="field">
                                    <p class="control is-expanded has-icons-left">
                                        <input class="input" type="TEXT" placeholder="Name" name="prog_by">
                                        <span class="icon  is-left">
                                            <i data-feather="user"></i>
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div id="qty_check_noti" class="notification is-warning" style="display: none">
                            <p><span class="icon icon-btn"><i data-feather="alert-circle"></i></span> Entered quanity
                                exceeds program quantity by <span id="qty_exceed" class="robo"></span> </p>
                        </div>
                        <div id="qty_check_noti_less" class="notification is-info" style="display: none">
                            <p><span class="icon icon-btn"><i data-feather="alert-circle"></i></span> Entered quanity
                                less than program quantity by <span id="qty_exceed_less" class="robo"></span> </p>
                        </div>

                        <div class="field is-horizontal">
                            <div class="field-label is-normal">
                                <label class="label">Size/Design/Colour </label>
                            </div>
                            <div class="field-body" id="size_fld">
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="text" name="s_0" placeholder="Size">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="text" name="s_1" placeholder="Size">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="text" name="s_2" placeholder="Size">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="text" name="s_3" placeholder="Size">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="text" name="s_4" placeholder="Size">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="text" name="s_5" placeholder="Size">
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="field is-horizontal">
                            <div class="field-label is-normal">
                                <label class="label">Qty </label>
                            </div>
                            <div class="field-body" id="qty_fld">
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="number" class="sub_qty" name="q_0" placeholder="Qty">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="number" class="sub_qty" name="q_1" placeholder="Qty">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="number" class="sub_qty" name="q_2" placeholder="Qty">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="number" class="sub_qty" name="q_3" placeholder="Qty">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="number" class="sub_qty" name="q_4" placeholder="Qty">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control is-expanded">
                                        <input class="input" type="number" class="sub_qty" name="q_5" placeholder="Qty">
                                    </p>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <p class="robo">Raw Material Required</p>
                        <br>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Raw Material - Fabric</th>
                                        <th>U.O.M</th>
                                        <th>Per Pc. Consum.</th>
                                        <th>Qty Required</th>
                                        <th>Qty Issued</th>
                                        <th>Qty Return</th>
                                        <th>Net Consum.</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody class="input_fields_wrap_fab">
                                    <tr>
                                        <td>
                                            <div class="select"><select id="fab_selector" class="fab_sel_cls"
                                                    name="fab_sel[0]">

                                                </select>
                                            </div>
                                        </td>
                                        <td><input type="text" class="input" name="fab_sel_uom[0]" readonly></td>
                                        <td><input type="number" class="input" name="fab_pr_pc[0]" /></td>
                                        <td><input type="number" class="input" name="fab_qty_req[0]" readonly
                                                readonly /></td>
                                        <td><input type="number" class="input" name="fab_qty_iss[0]" /></td>
                                        <td><input type="number" class="input" name="fab_qty_ret[0]" /></td>
                                        <td><input type="number" class="input" name="fab_net_con[0]" /></td>
                                        <td></td>
                                    </tr>
                                    <script>
                                        $(document).ready(function () {
                                            var options = [];
                                            $.getJSON("{{url_for('get_raw_prod')}}", function (result) {
                                                var leng = Object.keys(result).length
                                                for (var i = 0; i < leng; i++) {
                                                    options.push('<option value="',
                                                        Object.keys(result)[i], '">',
                                                        Object.values(result)[i], '</option>');
                                                }
                                                $(".fab_sel_cls").html(options.join(''));
                                                $(".fab_sel_cls").prop("selectedIndex", -1);
                                                // var pp_sel = $("select[name='fab_sel[0]']").val()
                                                // $.getJSON("/get/uom/raw_fab/" + pp_sel, function (result) {
                                                //     $("input[name='fab_sel_uom[0]']").val(result);
                                                // });

                                            });
                                        });

                                    </script>
                                    <script>
                                        $("select[name='fab_sel[0]']").on('change', function () {
                                            var pp_sel = $("select[name='fab_sel[0]']").val()
                                            $.getJSON("/get/uom/raw_fab/" + pp_sel, function (result) {
                                                $("input[name='fab_sel_uom[0]']").val(result);
                                            });
                                        })
                                    </script>
                                </tbody>
                            </table>
                        </div>
                        <button id="add_field_button_fab" class=" button is-primary"><span class="icon icon-btn-in"><i
                                    data-feather="plus"></i></span>Add More</button>


                        <br>

                        <hr>
                        <div class="table-container">

                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Finished Goods - Fabric</th>
                                        <th>U.O.M</th>
                                        <th>Per Pc. Consum.</th>
                                        <th>Qty Required</th>
                                        <th>Qty Issued</th>
                                        <th>Qty Return</th>
                                        <th>Net Consum.</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody class="input_fields_wrap_fin">
                                    <tr>
                                        <td>
                                            <div class="select"><select id="fin_selector" class="fin_sel_cls"
                                                    name="fin_sel[0]">

                                                </select>
                                            </div>
                                        </td>
                                        <td><input type="text" class="input" name="fin_sel_uom[0]" readonly></td>
                                        <td><input type="number" class="input" name="fin_pr_pc[0]" /></td>
                                        <td><input type="number" class="input" name="fin_qty_req[0]" readonly
                                                readonly /></td>
                                        <td><input type="number" class="input" name="fin_qty_iss[0]" /></td>
                                        <td><input type="number" class="input" name="fin_qty_ret[0]" /></td>
                                        <td><input type="number" class="input" name="fin_net_con[0]" /></td>
                                        <td></td>
                                    </tr>
                                    <script>
                                        $(document).ready(function () {
                                            var options = [];
                                            $.getJSON("{{url_for('get_fin_prod')}}", function (result) {
                                                var leng = Object.keys(result).length
                                                for (var i = 0; i < leng; i++) {
                                                    options.push('<option value="',
                                                        Object.keys(result)[i], '">',
                                                        Object.values(result)[i], '</option>');
                                                }
                                                $(".fin_sel_cls").html(options.join(''));
                                                $(".fin_sel_cls").prop("selectedIndex", -1);
                                                // var pp_sel = $("select[name='fin_sel[0]']").val()
                                                // $.getJSON("/get/uom/" + pp_sel, function (result) {
                                                //     $("input[name='fin_sel_uom[0]']").val(result);
                                                // });

                                            });
                                        });

                                    </script>
                                    <script>
                                        $("select[name='fin_sel[0]']").on('change', function () {
                                            var pp_sel = $("select[name='fin_sel[0]']").val()
                                            $.getJSON("/get/uom/" + pp_sel, function (result) {
                                                $("input[name='fin_sel_uom[0]']").val(result);
                                            });
                                        })
                                    </script>
                                </tbody>
                            </table>
                        </div>
                        <button id="add_field_button_fin" class=" button is-primary"><span class="icon icon-btn-in"><i
                                    data-feather="plus"></i></span>Add More</button>


                        <br>

                        <hr>
                        <div class="table-container">

                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Accessories</th>
                                        <th>U.O.M</th>

                                        <th>Per Pc. Consum.</th>
                                        <th>Qty Required</th>
                                        <th>Qty Issued</th>
                                        <th>Qty Return</th>
                                        <th>Net Consum.</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody class="input_fields_wrap_acc">
                                    <tr>
                                        <td>
                                            <div class="select"><select id="acc_selection" class="acc_selector"
                                                    name="acc_sel[0]">

                                                </select>
                                            </div>
                                        </td>
                                        <td><input type="text" class="input" name="acc_sel_uom[0]" readonly></td>
                                        <td><input type="number" class="input" name="acc_pr_pc[0]" /></td>
                                        <td><input type="number" class="input" name="acc_qty_req[0]" readonly
                                                readonly /></td>
                                        <td><input type="number" class="input" name="acc_qty_iss[0]" /></td>
                                        <td><input type="number" class="input" name="acc_qty_ret[0]" /></td>
                                        <td><input type="number" class="input" name="acc_net_con[0]" /></td>
                                        <td></td>
                                    </tr>
                                    <script>
                                        $(document).ready(function () {
                                            var options = [];
                                            $.getJSON("{{url_for('get_acc')}}", function (result) {
                                                for (var j = 0; j < Object.keys(result).length; j++) {
                                                    options.push('<option value="',
                                                        Object.keys(result)[j], '">',
                                                        Object.values(result)[j], '</option>');
                                                }
                                                $(".acc_selector").html(options.join(''));
                                                $(".acc_selector").prop("selectedIndex", -1);
                                                var pp_sel = $("select[name='acc_sel[0]']").val()


                                            });

                                            $("select[name='acc_sel[0]']").on('change', function () {
                                                var acc_pp_sel = $("select[name='acc_sel[0]']").val()
                                                $.getJSON("/get/uom/acc/" + acc_pp_sel, function (result) {
                                                    $("input[name='acc_sel_uom[0]']").val(result);
                                                });
                                            })

                                        })
                                    </script>
                                </tbody>
                            </table>
                        </div>
                        <button id="add_field_button_acc" class=" button is-primary"><span class="icon icon-btn-in"><i
                                    data-feather="plus"></i></span>Add More</button>


                        <br>
                        <hr>
                        <div class="table-container">

                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Other Materials</th>
                                        <th>U.O.M</th>

                                        <th>Per Pc. Consum.</th>
                                        <th>Qty Required</th>
                                        <th>Qty Issued</th>
                                        <th>Qty Return</th>
                                        <th>Net Consum.</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody class="input_fields_wrap_oth">
                                    <tr>
                                        <td>
                                            <div class="select"><select class="oth_selector" name="oth_sel[0]">

                                                </select>
                                            </div>
                                        </td>
                                        <td><input type="text" class="input" name="oth_sel_uom[0]" readonly></td>
                                        <td><input type="number" class="input" name="oth_pr_pc[0]" /></td>
                                        <td><input type="number" class="input" name="oth_qty_req[0]" readonly /></td>
                                        <td><input type="number" class="input" name="oth_qty_iss[0]" /></td>
                                        <td><input type="number" class="input" name="oth_qty_ret[0]" /></td>
                                        <td><input type="number" class="input" name="oth_net_con[0]" /></td>
                                        <td></td>
                                    </tr>
                                    <script>
                                        $(document).ready(function () {
                                            var options = [];
                                            $.getJSON("{{url_for('get_oth_mat')}}", function (result) {
                                                for (var j = 0; j < Object.keys(result).length; j++) {
                                                    options.push('<option value="',
                                                        Object.keys(result)[j], '">',
                                                        Object.values(result)[j], '</option>');
                                                }
                                                $(".oth_selector").html(options.join(''));
                                                $(".oth_selector").prop("selectedIndex", -1);
                                                var pp_sel = $("select[name='oth_sel[0]']").val()

                                            });

                                            $("select[name='oth_sel[0]']").on('change', function () {
                                                oth_pp_sel = $("select[name='oth_sel[0]']").val()
                                                $.getJSON("/get/uom/oth/" + oth_pp_sel, function (result) {
                                                    $("input[name='oth_sel_uom[0]']").val(result);
                                                });
                                            })
                                        })
                                    </script>
                                </tbody>
                            </table>
                        </div>
                        <button id="add_field_button_oth" class=" button is-primary"><span class="icon icon-btn-in"><i
                                    data-feather="plus"></i></span>Add More</button>


                        <br>
                        <br>
                        <hr>
                        <h2 class="robo">Uploads</h2>
                        <br>
                        <div id="drag-drop-area">
                        </div>
                        <script>
                            var uppy = Uppy.Core({ autoProceed: true })
                            var pp_num = '{{pp_num}}'
                            uppy.use(Uppy.Dashboard, {
                                target: '#drag-drop-area', autoProceed: true,
                                inline: true, width: '100%', height: 100
                            })
                            uppy.use(Uppy.XHRUpload, { endpoint: '/trans_a/uploads/' + pp_num, formData: true, method: 'POST', fieldName: 'files[]' })
                        </script>

                        <hr>


                    </form>
                </div>
            </div>
        </div>


    </div>

</div>
<nav class="navbar is-fixed-bottom has-shadow" id="form-cta">
    <div class="container">
        <div class="columns is-mobile is-centered">
            <div class="column is-three-quarters">
                <div class="field is-grouped">
                    <div class="control">
                        <button id="submit_btn_trans_a" class="button is-black"><span class="icon icon-btn-in"><i
                                    data-feather="check"></i></span>Save</button>
                    </div>

                    <div class="control ">
                        <a class="button is-text">Clear Fields</a>
                    </div>
                </div>
            </div>
        </div>

    </div>
</nav>

<br>
<br>

<script>

    $('#submit_btn_trans_a').click(function (e) {
        e.preventDefault();

        var data = $("#trans_a_form").serializeJSON();
        var formData = $("#trans_a_form :input")
            .filter(function (index, element) {
                return $(element).val() != '';
            })
            .serializeJSON();

        $.ajax({
            url: "{{url_for('trans_a')}}",
            type: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            async: false,
            success: function (msg) {
                window.location.href = "{{url_for('trans_a')}}";
            }
        });

    });

    $('#save_trans_a').click(function (e) {
        e.preventDefault();

        var get_data = $.Deferred();
        var data = $("#trans_a_form").serializeJSON();
        var formData = $("#trans_a_form :input")
            .filter(function (index, element) {
                return $(element).val() != '';
            })
            .serializeJSON();
        get_data.resolve();
        console.log(data);
        get_data.done(function () {
            $.ajax({
                url: "{{url_for('save_trans')}}",
                type: 'POST',
                data: JSON.stringify(formData),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                success: function (msg) {
                    console.log("Saved state");
                }
            });

        })



    });
</script>
<script>


    $(document).ready(function () {
        $('input[name*="dates"]').daterangepicker({
            "locale": {
                "format": "DD/MM/YYYY"
            }, "singleDatePicker": true, buttonClasses: 'button', applyButtonClasses: 'is-primary', cancelButtonClasses: 'is-text'
        });


        // Calling Logic for defined fields
        $("input[name*='acc']").keyup(function () {
            logic_pa_acc();
        });
        $("input[name*='fin']").keyup(function () {
            logic_pa_fin();
        });
        $("input[name*='fab']").keyup(function () {
            logic_pa_fab();
        });
        $("input[name*='oth']").keyup(function () {
            logic_pa_oth();
        });

        var max_fields = 10; //maximum input boxes allowed


        // Fab Code

        var wrapper_fab = $(".input_fields_wrap_fab"); //Fields wrapper
        var add_button_fab = $("#add_field_button_fab"); //Add button ID

        var fab_x = 1; //initlal text box count

        $(add_button_fab).click(function (e) { //on add input button click
            e.preventDefault();
            add_fab_fields(fab_x);

        });

        $(wrapper_fab).on("click", ".remove_field", function (e) { //user click on remove text
            e.preventDefault();
            $(this).parent('td').parent('tr').remove(); fab_x--;
        })

        // Fin Code

        var wrapper_fin = $(".input_fields_wrap_fin"); //Fields wrapper
        var add_button_fin = $("#add_field_button_fin"); //Add button ID

        var fin_x = 1; //initlal text box count

        $(add_button_fin).click(function (e) { //on add input button click
            e.preventDefault();
            add_fin_fields(fin_x);

        });

        $(wrapper_fin).on("click", ".remove_field", function (e) { //user click on remove text
            e.preventDefault();
            $(this).parent('td').parent('tr').remove(); fin_x--;
        })

        // Acc Code

        var wrapper_acc = $(".input_fields_wrap_acc"); //Fields wrapper
        var add_button_acc = $("#add_field_button_acc"); //Add button ID

        var acc_x = 1; //initlal text box count

        $(add_button_acc).click(function (e) { //on add input button click
            e.preventDefault();
            add_acc_fields(acc_x);
        });

        $(wrapper_acc).on("click", ".remove_field", function (e) { //user click on remove text
            e.preventDefault();
            $(this).parent('td').parent('tr').remove(); x--;
        })


        // Oth Code

        var wrapper_oth = $(".input_fields_wrap_oth"); //Fields wrapper
        var add_button_oth = $("#add_field_button_oth"); //Add button ID

        var oth_x = 1; //initlal text box count

        $(add_button_oth).click(function (e) { //on add input button click
            e.preventDefault();
            add_oth_fields(oth_x);

        });

        $(wrapper_oth).on("click", ".remove_field", function (e) { //user click on remove text
            e.preventDefault();
            $(this).parent('td').parent('tr').remove(); x--;
        })

        //  Populates all the fields


        function add_fab_fields(x) {
            if (x < max_fields) { //max input box allowed
                fab_x++; //text box increment
                $(wrapper_fab).append('<tr> \
                        <td><div class="select"><select  class="fab_sel_cls" name="fab_sel['+ x + ']"></select></div></td>\
                        <td><input type="text" class="input" name="fab_sel_uom['+ x + ']" readonly></td>\
                        <td><input type="number" class="input" name="fab_pr_pc['+ x + ']"/></td>\
                        <td><input type="number" class="input" name="fab_qty_req['+ x + ']" readonly/></td> \
                        <td><input type = "number" class= "input" name = "fab_qty_iss['+ x + ']" /></td>\
                        <td><input type="number" class="input" name="fab_qty_ret['+ x + ']" /></td>\
                        <td><input type="number" class="input" name="fab_net_con['+ x + ']" /></td>\
                        <td><a class="button is-danger remove_field"><span class="icon icon-btn-in-x"><i \
                                        data-feather="x"></i></span></a></td></tr> ');
                feather.replace();

                var options = [];
                $.getJSON("{{url_for('get_raw_prod')}}", function (result) {
                    for (var j = 0; j < Object.keys(result).length; j++) {
                        options.push('<option value="',
                            Object.keys(result)[j], '">',
                            Object.values(result)[j], '</option>');
                    }
                    $("select[name='fab_sel[" + x + "]']").html(options.join(''));
                    $("select[name='fab_sel[" + x + "]']").prop("selectedIndex", -1);
                    var pp_sel = $("select[name='fab_sel[" + x + "]']").val()
                    $.getJSON("/get/uom/raw_fab/" + pp_sel, function (result) {
                        $("input[name='fab_sel_uom[" + x + "]']").val(result);
                    });


                });

                $("select[name='fab_sel[" + x + "]']").on('change', function () {

                    var pp_sel = $("select[name='fab_sel[" + x + "]']").val()
                    $.getJSON("/get/uom/raw_fab/" + pp_sel, function (result) {
                        $("input[name='fab_sel_uom[" + x + "]']").val(result);
                    });
                })

                $("input[name*='fab']").keyup(function () {
                    logic_pa_fab();
                });

            }


        }

        function add_acc_fields(x) {
            if (x < max_fields) { //max input box allowed
                acc_x++; //text box increment
                $(wrapper_acc).append('<tr> \
                        <td><div class="select"><select class="acc_selector" name="acc_sel['+ x + ']"></select></div></td>\
                        <td><input type="text" class="input" name="acc_sel_uom['+ x + ']" readonly></td> \
                        <td><input type="number" class="input" name="acc_pr_pc['+ x + ']"/></td>\
                        <td><input type="number" class="input" name="acc_qty_req['+ x + ']" readonly/></td> \
                        <td><input type = "number" class= "input" name = "acc_qty_iss['+ x + ']" /></td>\
                        <td><input type="number" class="input" name="acc_qty_ret['+ x + ']" /></td>\
                        <td><input type="number" class="input" name="acc_net_con['+ x + ']" /></td>\
                        <td><a class="button is-danger remove_field"><span class="icon icon-btn-in-x"><i \
                                data-feather="x"></i></span></a></td></tr> ');
                feather.replace();


                var options = [];
                $.getJSON("{{url_for('get_acc')}}", function (result) {
                    for (var j = 0; j < Object.keys(result).length; j++) {
                        options.push('<option value="',
                            Object.keys(result)[j], '">',
                            Object.values(result)[j], '</option>');
                    }
                    $(".acc_selector_" + x + "").html(options.join(''));

                    $("select[name='acc_sel[" + x + "]']").html(options.join(''));
                    $("select[name='acc_sel[" + x + "]']").prop("selectedIndex", -1);
                    var acc_pp_sel = $("select[name='acc_sel[" + x + "]']").val();

                    $.getJSON("/get/uom/acc/" + acc_pp_sel, function (result) {
                        $("input[name='acc_sel_uom[" + x + "]']").val(result);
                    });
                });


                $("select[name='acc_sel[" + x + "]']").on('change', function () {

                    var pp_sel = $("select[name='acc_sel[" + x + "]']").val()
                    $.getJSON("/get/uom/acc/" + pp_sel, function (result) {
                        $("input[name='acc_sel_uom[" + x + "]']").val(result);
                    });
                })

                $("input[name*='acc']").keyup(function () {
                    logic_pa_acc();
                });
                // End Calc Login


            }



        }

        function add_oth_fields(x) {
            if (x < max_fields) { //max input box allowed
                oth_x++; //text box increment
                $(wrapper_oth).append('<tr> \
                        <td><div class="select"><select class="oth_selector" name="oth_sel['+ x + ']"></select></div></td>\
                        <td><input type="text" class="input" name="oth_pr_uom['+ x + ']" readonly></td>\
                        <td><input type="number" class="input" name="oth_pr_pc['+ x + ']"/></td>\
                        <td><input type="number" class="input" name="oth_qty_req['+ x + ']" readonly/></td> \
                        <td><input type = "number" class= "input" name = "oth_qty_iss['+ x + ']" /></td>\
                        <td><input type="number" class="input" name="oth_qty_ret['+ x + ']" /></td>\
                        <td><input type="number" class="input" name="oth_net_con['+ x + ']" /></td>\
                        <td><a class="button is-danger remove_field"><span class="icon icon-btn-in-x"><i \
                                        data-feather="x"></i></span></a></td></tr> ');
                feather.replace();


                var options = [];
                $.getJSON("{{url_for('get_oth_mat')}}", function (result) {
                    for (var j = 0; j < Object.keys(result).length; j++) {
                        options.push('<option value="',
                            Object.keys(result)[j], '">',
                            Object.values(result)[j], '</option>');
                    }
                    $("select[name='oth_sel[" + x + "]']").html(options.join(''));

                    var oth_pp_sel = $("select[name='oth_sel[" + x + "]']").val();
                    $("select[name='oth_sel[" + x + "]']").prop("selectedIndex", -1);
                  
                });

                $("select[name='oth_sel[" + x + "]']").on('change', function () {
                    var pp_sel = $("select[name='oth_sel[" + x + "]']").val()
                    $.getJSON("/get/uom/oth/" + pp_sel, function (result) {
                        $("input[name='oth_pr_uom[" + x + "]']").val(result);
                    });
                })

                $("input[name*='oth']").keyup(function () {
                    logic_pa_oth();
                });


                // End Math Logic



            }

        }

        function add_fin_fields(x) {
            if (x < max_fields) { //max input box allowed
                fin_x++; //text box increment
                $(wrapper_fin).append('<tr> \
                    <td><div class="select"><select  class="fin_sel_cls" name="fin_sel['+ x + ']"></select></div></td>\
                    <td><input type="text" class="input" name="fin_sel_uom['+ x + ']" readonly></td>\
                    <td><input type="number" class="input" name="fin_pr_pc['+ x + ']"/></td>\
                    <td><input type="number" class="input" name="fin_qty_req['+ x + ']" readonly/></td> \
                    <td><input type = "number" class= "input" name = "fin_qty_iss['+ x + ']" /></td>\
                    <td><input type="number" class="input" name="fin_qty_ret['+ x + ']" /></td>\
                    <td><input type="number" class="input" name="fin_net_con['+ x + ']" /></td>\
                    <td><a class="button is-danger remove_field"><span class="icon icon-btn-in-x"><i \
                                        data-feather="x"></i></span></a></td></tr> ');
                feather.replace();
                var options = [];
                $.getJSON("{{url_for('get_fin_prod')}}", function (result) {
                    for (var j = 0; j < Object.keys(result).length; j++) {
                        options.push('<option value="',
                            Object.keys(result)[j], '">',
                            Object.values(result)[j], '</option>');
                    }
                    $("select[name='fin_sel[" + x + "]']").html(options.join(''));
                    $("select[name='fin_sel[" + x + "]']").prop("selectedIndex", -1);
                    var pp_sel = $("select[name='fin_sel[" + x + "]']").val()
                    $.getJSON("/get/uom/" + pp_sel, function (result) {
                        $("input[name='fin_sel_uom[" + x + "]']").val(result);
                    });




                });
                $("select[name='fin_sel[" + x + "]']").on('change', function () {

                    var pp_sel = $("select[name='fin_sel[" + x + "]']").val()
                    $.getJSON("/get/uom/" + pp_sel, function (result) {
                        $("input[name='fin_sel_uom[" + x + "]']").val(result);
                    });
                })

                $("input[name*='fin']").keyup(function () {
                    logic_pa_fin();
                });
            }


        }

        function logic_pa_fin() {
            console.log("inside login_pa")
            $(".input_fields_wrap_fin tr").each(function (index, value) {
                var qty = parseFloat($("[name='prog_qty']").val());
                var tempx = parseFloat($((((value).children)[2]).children).val());

                var qty_req = $((((value).children)[3]).children);

                var qty_iss = parseFloat($((((value).children)[4]).children).val());
                console.log(qty_iss)
                var qty_ret = parseFloat($((((value).children)[5]).children).val());
                console.log(qty_ret)

                var net_con = $((((value).children)[6]).children);

                qty_req.val(parseFloat(qty * tempx));
                net_con.val(parseFloat(qty_iss - qty_ret));
            })
        }

        function logic_pa_fab() {
            console.log("inside login_pa")
            $(".input_fields_wrap_fab tr").each(function (index, value) {
                var qty = parseFloat($("[name='prog_qty']").val());
                var tempx = parseFloat($((((value).children)[2]).children).val());

                var qty_req = $((((value).children)[3]).children);

                var qty_iss = parseFloat($((((value).children)[4]).children).val());
                console.log(qty_iss)
                var qty_ret = parseFloat($((((value).children)[5]).children).val());
                console.log(qty_ret)

                var net_con = $((((value).children)[6]).children);

                qty_req.val(parseFloat(qty * tempx));
                net_con.val(parseFloat(qty_iss - qty_ret));
            })
        }

        function logic_pa_acc() {
            console.log("inside login_pa")
            $(".input_fields_wrap_acc tr").each(function (index, value) {
                var qty = parseFloat($("[name='prog_qty']").val());
                var tempx = parseFloat($((((value).children)[2]).children).val());

                var qty_req = $((((value).children)[3]).children);

                var qty_iss = parseFloat($((((value).children)[4]).children).val());
                console.log(qty_iss)
                var qty_ret = parseFloat($((((value).children)[5]).children).val());
                console.log(qty_ret)

                var net_con = $((((value).children)[6]).children);

                qty_req.val(parseFloat(qty * tempx));
                net_con.val(parseFloat(qty_iss - qty_ret));
            })
        }

        function logic_pa_oth() {
            console.log("inside login_pa")
            $(".input_fields_wrap_oth tr").each(function (index, value) {
                var qty = parseFloat($("[name='prog_qty']").val());
                var tempx = parseFloat($((((value).children)[2]).children).val());

                var qty_req = $((((value).children)[3]).children);

                var qty_iss = parseFloat($((((value).children)[4]).children).val());
                console.log(qty_iss)
                var qty_ret = parseFloat($((((value).children)[5]).children).val());
                console.log(qty_ret)

                var net_con = $((((value).children)[6]).children);

                qty_req.val(parseFloat(qty * tempx));
                net_con.val(parseFloat(qty_iss - qty_ret));
            })
        }

        // Flattens JSON for HTML elements

        function json2html_name_list(json, result, parent) {
            if (!result) result = {};
            if (!parent) parent = '';
            if ((typeof json) != 'object') {
                result[parent] = json;
            } else {
                for (var key in json) {
                    var value = json[key];
                    if (parent == '') var subparent = key;
                    else var subparent = parent + '[' + key + ']';
                    result = json2html_name_list(value, result, subparent);
                }
            }
            return result;
        }


        function populate(frm, data) {
            $.each(data, function (key, value) {
                if (key === 'PP_no') {

                }
                else {
                    $('[name="' + key + '"]', frm).val(value).fadeIn();
                }
                if (key === 'samp_iss') {
                    $('input:radio[name=' + key + ']').filter('[value="' + value + '"]').prop('checked', true);
                }
                if (key === 'prog_qty') {
                    $('[name="' + key + '"]', frm).val("");
                }
                if (key === 'start-dates') {
                    $('[name="' + key + '"]', frm).val("");
                }
                if (key === 'target-dates') {
                    $('[name="' + key + '"]', frm).val("");
                }

            });
        }




        $("#copy_from_last_row").click(function (e) {
            e.preventDefault();
            $.getJSON("{{url_for('trans_a_api_last')}}", function (result) {

                var part_a;

                part_a = $.parseJSON(result['trans_data']['part_a']);
                var all_sel_load = $.Deferred();

                console.log(part_a);
                if ($.isEmptyObject(result)) {

                    console.log('Boy , its empty ');
                    $('#trans_b_form').trigger("reset");

                }
                else {
                    console.log('Boy , its full ');


                    var extra_fld_fab = Object.keys(part_a['fab_sel']).length;


                    for (var new_x = 1; new_x < extra_fld_fab; new_x++) {

                        add_fab_fields(new_x);
                    }

                    var extra_fld_fin = Object.keys(part_a['fin_sel']).length;


                    for (var new_x = 1; new_x < extra_fld_fin; new_x++) {

                        add_fin_fields(new_x);

                    }

                    var extra_fld_acc = Object.keys(part_a['acc_sel']).length;

                    for (var new_x = 1; new_x < extra_fld_acc; new_x++) {
                        add_acc_fields(new_x);
                    }

                    var extra_fld_oth = Object.keys(part_a['oth_sel']).length;

                    for (var new_x = 1; new_x < extra_fld_oth; new_x++) {
                        add_oth_fields(new_x);
                    }
                    console.log('Resolves - row add');

                };
                all_sel_load.resolve();


                var fab_sel_load = $.Deferred();

                $.getJSON("{{url_for('get_raw_prod')}}", function (result) {
                    var options = [];

                    for (var j = 0; j < Object.keys(result).length; j++) {
                        options.push('<option value="',
                            Object.keys(result)[j], '">',
                            Object.values(result)[j], '</option>');
                    }
                    $(".fab_sel_cls").html(options.join(''));

                }).done(function () {

                    console.log('Resolves - fab add');
                    fab_sel_load.resolve();
                })

                var fin_sel_load = $.Deferred();

                $.getJSON("{{url_for('get_fin_prod')}}", function (result) {
                    var options = [];

                    for (var j = 0; j < Object.keys(result).length; j++) {
                        options.push('<option value="',
                            Object.keys(result)[j], '">',
                            Object.values(result)[j], '</option>');
                    }
                    $(".fin_sel_cls").html(options.join(''));

                }).done(function () {

                    console.log('Resolves - fin add');
                    fin_sel_load.resolve();
                })

                var acc_sel_load = $.Deferred();

                $.getJSON("{{url_for('get_acc')}}", function (result) {
                    var options = [];

                    for (var j = 0; j < Object.keys(result).length; j++) {
                        options.push('<option value="',
                            Object.keys(result)[j], '">',
                            Object.values(result)[j], '</option>');
                    }
                    $(".acc_selector").html(options.join(''));



                }).done(function () {

                    console.log('Resolves - acc add');
                    acc_sel_load.resolve();
                })

                var oth_sel_load = $.Deferred();

                $.getJSON("{{url_for('get_oth_mat')}}", function (result) {
                    var options = [];

                    for (var j = 0; j < Object.keys(result).length; j++) {
                        options.push('<option value="',
                            Object.keys(result)[j], '">',
                            Object.values(result)[j], '</option>');
                    }
                    $(".oth_selector").html(options.join(''));
                }).done(function () {

                    oth_sel_load.resolve();
                })

                $.when(fab_sel_load, fin_sel_load, acc_sel_load, oth_sel_load).then(function () {

                    var rs = json2html_name_list(part_a);
                    populate('#trans_a_form', rs);

                });


            })







        });

    });
        // Fucnction for Adding Fabric Fields


</script>
<script>


    // Script to check against program quantity


    $("#qty_fld input").keyup(function () {
        console.log("EE")
        qty_check();
    });

    function qty_check() {
        var prog_qty = parseFloat($('input[name="prog_qty"]').val());

        var sum = parseFloat(0)

        $("#qty_fld input").each(function (index, value) {
            if (isNaN(parseFloat($(value).val()))) {
            }
            else {
                sum += parseFloat($(value).val())
                console.log(sum)

            }


        })
        console.log(sum)
        if (sum > prog_qty) {
            $("#qty_check_noti").addClass("animated shake").fadeIn();
            $("#qty_exceed").html('' + sum - prog_qty + '');
            $("#submit_btn_trans_a").attr('disabled', true);


        }
        else if (sum < prog_qty) {
            $("#qty_check_noti_less").addClass("animated shake").fadeIn();
            $("#qty_exceed_less").html('' + prog_qty - sum + '');
            $("#submit_btn_trans_a").attr('disabled', true);

        }
        else {
            $("#qty_check_noti").removeClass("animated shake").fadeOut();
            $("#qty_check_noti_less").removeClass("animated shake").fadeOut();
            $("#submit_btn_trans_a").attr('disabled', false);


        }
    }




</script>


{% endblock %}